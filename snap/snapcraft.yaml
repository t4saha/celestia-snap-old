name: celestia-daily # you probably want to 'snapcraft register <name>'
base: core22 # the base snap is the execution environment for this snap
#version: '0.+git' # just for humans, typically '1.2+git' or '1.3.2'
adopt-info: celestia-qt

summary: Free, open source, Real-time 3D visualization of space. # 79 char long summary
description: |
  Celestia is a real-time space simulation which lets you experience the universe in three dimensions. Celestia does not confine you to the surface of the Earth, it allows you to travel throughout the solar system, to any of over 100,000 stars, or even beyond the galaxy. Travel in Celestia is seamless; the exponential zoom feature lets you explore space across a huge range of scales, from galaxy clusters down to spacecraft only a few meters across. A 'point-and-goto' interface makes it simple to navigate through the universe to the object you want to visit.

grade: stable # must be 'stable' to release into candidate/stable channels
confinement: strict

architectures: #build Architectures
   - build-on: amd64 
   #- build-on: i386 #not supported by core 20 and above
   - build-on: arm64

# this line enables LZO compression for the snap
compression: lzo
   
apps:
  celestia-qt:
    command: desktop-launch $SNAP/bin/run-celestia-qt.sh
    #desktop: $SNAP/usr/share/applications/celestia.desktop
    plugs: [desktop, wayland, x11, unity7, gsettings, opengl, network, network-bind, audio-playback, home, raw-usb]
    environment:
      HOME: "$SNAP_USER_COMMON"
    
layout:
  /usr/share/celestia:
    bind: $SNAP/usr/share/celestia
  /usr/share/qt6:
    bind: $SNAP/usr/share/qt6
  /usr/share/X11:
    bind: $SNAP/usr/share/X11
  #/usr/lib:
    #bind: $SNAP/usr/lib
    
parts:
  celestia-qt:
    plugin: cmake
    configflags:
      - -DCMAKE_BUILD_TYPE=Release
      - -DCMAKE_INSTALL_PREFIX:PATH=/usr
      #- -DWITH_GTK_2_X = ON
      - -DENABLE_TTF=ON
      - -DUSE_QT6=ON
      - -DENABLE_DATA=ON

    source: https://github.com/CelestiaProject/Celestia.git
    source-type: git
    #source-depth : 1
    #source-tag: 1.6.2
    after : [desktop-celestia]
    
    override-pull: |  
      craftctl default
      snapcraftctl set-version "$(git describe --tags | awk '{ gsub("_","."); print $1 }')"

    override-build: |    
      craftctl default
      mkdir -p $CRAFT_PART_INSTALL/usr/share/icons/hicolor/128x128/apps
      cp ../src/src/celestia/qt/data/celestia.png $CRAFT_PART_INSTALL/usr/share/icons/hicolor/128x128/apps
    
    build-packages:
      - git
      - libepoxy-dev
      - libjpeg-dev
      - libpng-dev
      - libtheora-dev
      - libgl1-mesa-dev
      - libglu1-mesa-dev
      - libeigen3-dev
      - libfmt-dev
      - qt6-base-dev
      - qt6-base-dev-tools
      - libqt6opengl6-dev
      - liblua5.3-dev
      - libfreetype6-dev
      
    stage-packages:
      - libepoxy0
      - libgl1
      - libgl1-mesa-glx
      - libglu1-mesa
      - liblua5.3-0
      - libogg0
      - libqt6opengl6
      - qt6-wayland
      - libtheora0
      - libcanberra-gtk3-module
      - gtk3-nocsd

  wrapper:
    plugin: dump
    after : [celestia-qt]
    override-pull: |
      craftctl default
      chmod +x $CRAFT_PART_SRC/run-celestia-qt.sh
    source: ./snap/local
    source-type: local
    organize:
      run-celestia-qt.sh: bin/run-celestia-qt.sh
      
  celestia-content:
    source: https://github.com/CelestiaProject/CelestiaContent.git
    source-type: git
    source-depth : 1
    after : [desktop-celestia, celestia-qt]
    plugin: cmake
    configflags:
      - -DCMAKE_BUILD_TYPE=Release
      - -DCMAKE_INSTALL_PREFIX:PATH=/usr
    
  desktop-celestia:
    #source: https://github.com/ubuntu/snapcraft-desktop-helpers.git
    https://github.com/t4saha/snapcraft-desktop-helpers-Qt6.git
    source-subdir: qt
    source-depth : 1
    plugin: make
    make-parameters: ["FLAVOR=qt6"]
    build-packages:
      - build-essential
      #- qtbase5-dev
      - qt6-base-dev
      - dpkg-dev
    stage-packages:
      - libxkbcommon0
      - xkb-data
      - ttf-ubuntu-font-family
      - dmz-cursor-theme
      - light-themes
      - adwaita-icon-theme
      - gnome-themes-standard
      - shared-mime-info
      - libqt6gui6
      - libgdk-pixbuf2.0-0
    - libqt6svg6 # for loading icon themes which are svg
    - locales-all
    - xdg-user-dirs
    - libgtk2.0-0
    - qt6-qpa-plugins
    - qt6-wayland
    - qt6-gtk-platformtheme
    - libgtk-3-common
    - libglib2.0-bin
    - libglib2.0-0
    - libglib2.0-data
    - gsettings-desktop-schemas
